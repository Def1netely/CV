<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>University Payment Tracker</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#9fb0d0;
      --text:#e9efff;
      --accent:#5dd6c7;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(93,214,199,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(132,111,255,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      padding: 28px 14px 40px;
    }
    .wrap{max-width: 1200px; margin: 0 auto;}

    header{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom: 18px;
    }
    h1{margin:0; font-size: 28px; letter-spacing: .2px;}
    .subtitle{margin: 6px 0 0; color: var(--muted); font-size: 14px; line-height:1.35;}

    .pill{font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); color: var(--muted)}

    .grid{display:grid; grid-template-columns: 420px 1fr; gap: 18px;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

    .cards{display:grid; grid-template-columns: repeat(5, 1fr); gap: 12px;}
    @media (max-width: 980px){ .cards{grid-template-columns: repeat(2, 1fr);} }

    .cards3{display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px;}
    @media (max-width: 980px){ .cards3{grid-template-columns: repeat(2, 1fr);} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card .hd{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .card .hd h2{ margin:0; font-size: 15px; letter-spacing:.2px; }
    .card .bd{ padding: 16px; }

    .mini{ font-size: 12px; color: var(--muted); margin-top: 10px; line-height:1.35; }
    .hint{color: var(--muted); font-size: 12px; margin: 8px 0 0}

    label{display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px;}
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    input::placeholder{color: rgba(233,239,255,.45)}
    input:focus, select:focus{border-color: rgba(93,214,199,.55); box-shadow: 0 0 0 4px rgba(93,214,199,.10)}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;}
    .row.one{grid-template-columns: 1fr;}

    .btns{display:flex; gap: 10px; flex-wrap:wrap;}
    button{border:0; cursor:pointer; padding:10px 12px; border-radius:12px; font-weight:700; letter-spacing:.15px;}
    .primary{background: var(--accent); color: #07221f;}
    .ghost{background: rgba(255,255,255,.08); color: var(--text); border: 1px solid rgba(255,255,255,.12)}
    .danger{background: rgba(255,107,107,.15); color: #ffd7d7; border: 1px solid rgba(255,107,107,.28)}

    .tile{border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.16); border-radius: 16px; padding: 14px; cursor:pointer; transition: transform .12s ease, border-color .12s ease; user-select:none; min-height: 96px;}
    .tile:hover{ transform: translateY(-2px); border-color: rgba(93,214,199,.5); }
    .tile .k{ font-size: 12px; color: var(--muted); }
    .tile .v{ font-size: 20px; font-weight: 900; margin-top: 6px; letter-spacing:.2px; }
    .tile .s{ font-size: 12px; color: rgba(233,239,255,.75); margin-top: 8px; line-height:1.2; }

    .toolbar{display:flex; gap: 10px; flex-wrap:wrap; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid var(--border);}
    .search{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .search input{ width: 320px; max-width: 100%; }

    table{width:100%; border-collapse: collapse;}
    th, td{padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,.08); text-align:left; font-size: 13px;}
    th{color: var(--muted); font-size: 12px; font-weight: 700; letter-spacing:.2px;}
    .mono{font-family: var(--mono);}

    .toast{position: fixed; right: 16px; bottom: 16px; padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,.14); background: rgba(17,26,46,.9); box-shadow: var(--shadow); max-width: 360px; opacity: 0; transform: translateY(8px); transition: .18s ease; pointer-events:none; font-size: 13px; color: var(--text); z-index: 50;}
    .toast.show{opacity:1; transform: translateY(0);} .toast b{color: var(--accent)}

    .crumbs{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .crumbs a{color: var(--muted); text-decoration:none; border-bottom:1px dashed rgba(255,255,255,.18)}
    .crumbs a:hover{color: var(--text)}

    .split{display:flex; gap: 12px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top: 6px;}
    .muted{color: var(--muted)}
    .right{ text-align:right; }

    .loader{display:inline-flex; align-items:center; gap:8px; color: var(--muted); font-size: 12px;}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(93,214,199,.7); animation: pulse 1s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:.15s} .dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,100%{opacity:.35; transform: scale(.9)}50%{opacity:1; transform:scale(1)}}

    .footnote{margin-top: 10px; color: rgba(233,239,255,.7); font-size: 12px; line-height:1.35;}

    details{border-top: 1px solid rgba(255,255,255,.08); margin-top: 12px; padding-top: 12px;}
    summary{cursor:pointer; color: var(--muted); font-size: 12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="pageTitle">University Payment Tracker</h1>
        <div class="subtitle" id="pageSubtitle">Day 1–5 payment tracking per college. Amount is fixed at <b>₱60</b> per paid student.</div>
        <div class="split">
          <div class="crumbs" id="crumbs"></div>
          <div class="pill" id="statusPill">Ready</div>
        </div>
      </div>
      <div class="pill" id="countPill">0 payments</div>
    </header>

    <!-- HOME VIEW -->
    <section id="homeView" style="display:none;">
      <div class="card">
        <div class="hd">
          <h2>Days 1–5</h2>
          <div class="loader" id="homeLoader" style="display:none;">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            Loading summary…
          </div>
        </div>
        <div class="bd">
          <div class="cards" id="dayCards"></div>
          <div class="footnote">Tip: Click a day to view colleges, then choose a college tracker to encode payments.</div>
        </div>
      </div>

      <div style="height: 14px"></div>

      <div class="card">
        <div class="hd">
          <h2>Overall Summary</h2>
          <div class="muted" style="font-size:12px;">Counts use unique Student IDs per day.</div>
        </div>
        <div class="bd" id="overallSummary"></div>
      </div>
    </section>

    <!-- DAY VIEW -->
    <section id="dayView" style="display:none;">
      <div class="card">
        <div class="hd">
          <h2 id="dayViewTitle">Day</h2>
          <div class="btns"><button class="ghost" id="backHomeBtn" type="button">← Home</button></div>
        </div>
        <div class="bd">
          <div class="cards3" id="collegeCards"></div>
          <div class="footnote">Click a college to open its tracker for this day.</div>
        </div>
      </div>

      <div style="height: 14px"></div>

      <div class="card">
        <div class="hd">
          <h2>Day Summary</h2>
          <div class="loader" id="dayLoader" style="display:none;">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            Loading…
          </div>
        </div>
        <div class="bd" id="daySummary"></div>
      </div>
    </section>

    <!-- TRACKER VIEW -->
    <section id="trackerView" style="display:none;">
      <div class="grid">
        <section class="card">
          <div class="hd">
            <h2 id="trackerTitle">New Payment</h2>
            <div class="btns">
              <button class="ghost" id="backDayBtn" type="button">← Back</button>
              <button class="ghost" id="resetFormBtn" type="button">Reset</button>
              <button class="primary" id="addBtn" type="button">Add Payment</button>
            </div>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label for="receiptId">Receipt ID</label>
                <input id="receiptId" placeholder="e.g., OR-2026-0001" />
              </div>
              <div>
                <label for="studentName">Student Name</label>
                <input id="studentName" placeholder="e.g., Juan Dela Cruz" />
              </div>
            </div>
            <div class="row one">
              <div>
                <label for="studentId">Student ID</label>
                <input id="studentId" placeholder="e.g., 2023-12345" />
              </div>
            </div>
            <div class="row">
              <div>
                <label for="yearLevel">Year Level</label>
                <select id="yearLevel"></select>
              </div>
              <div>
                <label>College (locked)</label>
                <input id="collegeLocked" disabled />
              </div>
            </div>
            <div class="row one">
              <div>
                <label for="course">Course</label>
                <select id="course"></select>
                <div class="hint">Amount is fixed at <b>₱60</b>. College is locked by the tracker.</div>
              </div>
            </div>

            <details>
              <summary>Configure dropdown options (Year Level / College / Course)</summary>
              <div style="margin-top: 12px;">
                <div class="card" style="box-shadow:none; background: rgba(0,0,0,.12); border-radius: 14px;">
                  <div class="bd" style="padding: 14px;">
                    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                      <div style="font-size: 13px; font-weight:700;">Year Levels</div>
                      <button class="ghost" id="resetYearsBtn" type="button">Reset defaults</button>
                    </div>
                    <div class="mini">Enter one option per line.</div>
                    <textarea id="yearOptions" rows="6" style="width:100%; margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); color:var(--text); font-family: var(--mono);"></textarea>
                    <div class="btns" style="margin-top:10px;"><button class="primary" id="saveYearsBtn" type="button">Save Year Levels</button></div>
                  </div>
                </div>

                <div style="height: 12px"></div>

                <div class="card" style="box-shadow:none; background: rgba(0,0,0,.12); border-radius: 14px;">
                  <div class="bd" style="padding: 14px;">
                    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                      <div style="font-size: 13px; font-weight:700;">Colleges</div>
                      <button class="ghost" id="resetCollegesBtn" type="button">Reset defaults</button>
                    </div>
                    <div class="mini">Enter one option per line.</div>
                    <textarea id="collegeOptions" rows="6" style="width:100%; margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); color:var(--text); font-family: var(--mono);"></textarea>
                    <div class="btns" style="margin-top:10px;"><button class="primary" id="saveCollegesBtn" type="button">Save Colleges</button></div>
                    <div class="mini">Note: Colleges here control what appears on Home/Day pages. Trackers use the college from the URL.</div>
                  </div>
                </div>

                <div style="height: 12px"></div>

                <div class="card" style="box-shadow:none; background: rgba(0,0,0,.12); border-radius: 14px;">
                  <div class="bd" style="padding: 14px;">
                    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                      <div style="font-size: 13px; font-weight:700;">Courses (by College)</div>
                      <button class="ghost" id="resetCoursesBtn" type="button">Reset defaults</button>
                    </div>
                    <div class="mini">Block format: separate blocks with a blank line. First line is <b>College key</b>, next lines are courses. Include a <b>_default</b> block.</div>
                    <textarea id="courseOptions" rows="10" style="width:100%; margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); color:var(--text); font-family: var(--mono);"></textarea>
                    <div class="btns" style="margin-top:10px;"><button class="primary" id="saveCoursesBtn" type="button">Save Courses</button></div>
                  </div>
                </div>
              </div>
            </details>

            <details>
              <summary>Export (current tracker only)</summary>
              <div style="margin-top: 12px;" class="btns">
                <button class="ghost" id="exportCsvBtn" type="button">Export CSV</button>
                <button class="ghost" id="exportPdfBtn" type="button">Export PDF</button>
                <button class="ghost" id="exportXlsxBtn" type="button">Export Excel</button>
              </div>
              <p class="mini">Exports download the currently visible tracker data (selected day & college). Source of truth is Google Sheets.</p>
            </details>
          </div>
        </section>

        <section class="card">
          <div class="toolbar">
            <div class="search">
              <div>
                <label for="q">Search</label>
                <input id="q" placeholder="Search receipt, student name, student ID, course…" />
              </div>
              <div>
                <label for="filterYear">Year Level</label>
                <select id="filterYear"></select>
              </div>
            </div>
            <div class="btns"><button class="ghost" id="clearFiltersBtn" type="button">Clear Filters</button></div>
          </div>
          <div class="bd" style="padding:0;">
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Receipt ID</th>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>Year</th>
                    <th>Course</th>
                    <th class="right">Amount</th>
                    <th style="width: 90px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =========================
    // CONFIG (YOU EDIT THIS)
    // =========================
    const API_URL = "https://script.google.com/macros/library/d/1l2kIQCZLn-QSyqWaiEUc1I5lYmksBZBtMy2Mf5HUL09JxLi5VeOtMNfG/1";
    const FIXED_AMOUNT = 60;

    // Dropdown options are still stored locally for convenience
    const KEY_OPTS = "uni_pt_options_v2";

    const defaultOptions = {
      years: ["1st Year", "2nd Year", "3rd Year", "4th Year", "Irregular"],
      colleges: ["CNSM", "COE", "CBAA", "CFAS", "COEd", "COA", "IIAIS", "CSSH", "CON"],
      courseMap: {
        CNSM: ["BS Biology", "BS Chemistry", "BS Mathematics", "BS Physics", "BS IT"],
        COE: ["BS Civil Engineering", "BS Electrical Engineering", "BS Mechanical Engineering"],
        CBAA: ["BS Accountancy", "BS Business Administration", "BS Human Resource Management"],
        _default: ["BSIT", "BSCS"]
      }
    };

    const $ = (id) => document.getElementById(id);
    const peso = (n) => new Intl.NumberFormat('en-PH', {style:'currency', currency:'PHP', maximumFractionDigits:0}).format(Number(n||0));
    const prettyDate = (iso) => new Date(iso).toLocaleString(undefined, { year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    const csvEscape = (v) => {
      const s = String(v ?? "");
      if (/\n|\r|\"|,/.test(s)) return '"' + s.replace(/\"/g, '""') + '"';
      return s;
    };

    function toast(msg){
      const t = $("toast");
      t.innerHTML = msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.classList.remove("show"), 2200);
    }

    function setStatus(text){ $("statusPill").textContent = text; }

    function qs(){
      const sp = new URLSearchParams(location.search);
      return { day: sp.get('day') || "", college: sp.get('college') || "" };
    }

    function goHome(){ location.href = location.pathname; }
    function goDay(day){ location.href = `${location.pathname}?day=${encodeURIComponent(day)}`; }
    function goTracker(day, college){ location.href = `${location.pathname}?day=${encodeURIComponent(day)}&college=${encodeURIComponent(college)}`; }

    function loadOptions(){
      try{
        const raw = localStorage.getItem(KEY_OPTS);
        if(!raw) return structuredClone(defaultOptions);
        const parsed = JSON.parse(raw);
        const opts = {
          years: Array.isArray(parsed.years) && parsed.years.length ? parsed.years : defaultOptions.years,
          colleges: Array.isArray(parsed.colleges) && parsed.colleges.length ? parsed.colleges : defaultOptions.colleges,
          courseMap: (parsed.courseMap && typeof parsed.courseMap === "object") ? parsed.courseMap : structuredClone(defaultOptions.courseMap),
        };
        if(!Array.isArray(opts.courseMap._default) || !opts.courseMap._default.length){
          opts.courseMap._default = structuredClone(defaultOptions.courseMap._default);
        }
        return opts;
      } catch(e){
        return structuredClone(defaultOptions);
      }
    }

    function saveOptions(opts){ localStorage.setItem(KEY_OPTS, JSON.stringify(opts)); }

    function getCoursesForCollege(opts, college){
      const list = opts.courseMap?.[college];
      if(Array.isArray(list) && list.length) return list;
      return opts.courseMap?._default || [];
    }

    function setSelectOptions(select, options, {includeAll=false, allLabel="All"} = {}){
      select.innerHTML = "";
      if(includeAll){
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = allLabel;
        select.appendChild(opt);
      }
      for(const o of options){
        const opt = document.createElement("option");
        opt.value = o; opt.textContent = o;
        select.appendChild(opt);
      }
    }

    function listToTextArea(list){ return (list || []).join("\n"); }
    function textAreaToList(text){ return text.split(/\r?\n/).map(s => s.trim()).filter(Boolean); }

    function syncOptionEditors(opts){
      $("yearOptions").value = listToTextArea(opts.years);
      $("collegeOptions").value = listToTextArea(opts.colleges);
      const blocks = [];
      for(const col of opts.colleges){ blocks.push([col, ...getCoursesForCollege(opts, col)].join("\n")); }
      blocks.push(["_default", ...(opts.courseMap?._default || [])].join("\n"));
      $("courseOptions").value = blocks.join("\n\n");
    }

    function parseCourseMapFromEditor(text, colleges){
      const blocks = text.split(/\n\s*\n/).map(b => b.trim()).filter(Boolean);
      const map = {};
      for(const b of blocks){
        const lines = b.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        if(!lines.length) continue;
        map[lines[0]] = lines.slice(1);
      }
      if(!Array.isArray(map._default) || !map._default.length){ map._default = structuredClone(defaultOptions.courseMap._default); }
      for(const c of colleges){ if(!Array.isArray(map[c])) map[c] = []; }
      return map;
    }

    async function apiGet(action, params = {}){
      if(!API_URL || API_URL.includes("PASTE_YOUR")) throw new Error("API_URL not set");
      const sp = new URLSearchParams({ action, ...params });
      const res = await fetch(`${API_URL}?${sp.toString()}`);
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Request failed");
      return data;
    }

    async function apiPost(action, body = {}){
      if(!API_URL || API_URL.includes("PASTE_YOUR")) throw new Error("API_URL not set");
      const res = await fetch(`${API_URL}?action=${encodeURIComponent(action)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Request failed");
      return data;
    }

    async function fetchPayments(day, college){ return (await apiGet('payments', { day, college })).payments || []; }
    async function addPaymentToServer(payload){ return apiPost('add', payload); }
    async function deletePaymentFromServer(id){ return apiPost('delete', { id }); }
    async function fetchSummary(day){ return apiGet('summary', { day }); }

    let CURRENT = { day:"", college:"" };
    let TRACKER_PAYMENTS = [];

    function setCrumbs(){
      const { day, college } = CURRENT;
      const c = $("crumbs");
      c.innerHTML = "";
      const home = document.createElement('a'); home.href = location.pathname; home.textContent = "Home"; c.appendChild(home);
      if(day){
        const sep1 = document.createElement('span'); sep1.textContent = "›"; sep1.className = "muted"; c.appendChild(sep1);
        const dayLink = document.createElement('a'); dayLink.href = `${location.pathname}?day=${encodeURIComponent(day)}`; dayLink.textContent = `Day ${day}`; c.appendChild(dayLink);
      }
      if(day && college){
        const sep2 = document.createElement('span'); sep2.textContent = "›"; sep2.className = "muted"; c.appendChild(sep2);
        const s = document.createElement('span'); s.className = "muted"; s.textContent = college; c.appendChild(s);
      }
    }

    function showView(which){
      $("homeView").style.display = which==='home' ? '' : 'none';
      $("dayView").style.display = which==='day' ? '' : 'none';
      $("trackerView").style.display = which==='tracker' ? '' : 'none';
    }

    function buildSummaryHTML(s, title){
      const byCollege = (s.byCollege||[]);
      const byYear = (s.byYearLevel||[]);
      const collegeRows = byCollege.map(r => `
        <tr><td>${r.key}</td><td class="right">${r.paidStudents}</td><td class="right">${peso((r.paidStudents||0)*FIXED_AMOUNT)}</td></tr>
      `).join('');
      const yearRows = byYear.map(r => `
        <tr><td>${r.key}</td><td class="right">${r.paidStudents}</td><td class="right">${peso((r.paidStudents||0)*FIXED_AMOUNT)}</td></tr>
      `).join('');
      return `
        <div style="font-weight:900; letter-spacing:.25px; margin-bottom:10px;">${title}</div>
        <div class="mini" style="margin-top:0;">Number of Paid Students per College</div>
        <div style="overflow:auto; margin-top:8px;">
          <table><thead><tr><th>College</th><th class="right"># Paid</th><th class="right">Total Amount</th></tr></thead>
          <tbody>${collegeRows || `<tr><td colspan="3" class="muted">No data yet</td></tr>`}</tbody></table>
        </div>
        <div class="mini" style="margin-top:14px;">Number of Paid Students per Year Level</div>
        <div style="overflow:auto; margin-top:8px;">
          <table><thead><tr><th>Year Level</th><th class="right"># Paid</th><th class="right">Total Amount</th></tr></thead>
          <tbody>${yearRows || `<tr><td colspan="3" class="muted">No data yet</td></tr>`}</tbody></table>
        </div>
      `;
    }

    async function renderHome(){
      showView('home');
      const opts = loadOptions();
      $("pageTitle").textContent = "University Payment Tracker";
      $("pageSubtitle").innerHTML = `Day 1–5 payment tracking per college. Amount is fixed at <b>₱${FIXED_AMOUNT}</b> per paid student.`;
      $("countPill").textContent = "—";
      setCrumbs();

      const dayCards = $("dayCards");
      dayCards.innerHTML = "";
      for(let d=1; d<=5; d++){
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerHTML = `<div class="k">DAY ${d}</div><div class="v" id="day${d}Total">—</div><div class="s" id="day${d}Meta">Tap to view colleges</div>`;
        tile.addEventListener('click', () => goDay(String(d)));
        dayCards.appendChild(tile);
      }

      $("homeLoader").style.display = '';
      const overall = $("overallSummary");
      overall.innerHTML = "";

      try{
        const all = [];
        for(let d=1; d<=5; d++){
          const s = await fetchSummary(String(d));
          all.push(s);
          const totalPaid = (s.byCollege || []).reduce((acc, r) => acc + (r.paidStudents||0), 0);
          const totalAmt = totalPaid * FIXED_AMOUNT;
          document.getElementById(`day${d}Total`).textContent = peso(totalAmt);
          document.getElementById(`day${d}Meta`).textContent = `${totalPaid} paid students · ${opts.colleges.length} colleges`;
        }
        overall.innerHTML = all.map(s => buildSummaryHTML(s, `DAY ${s.day}`)).join('<div style="height:12px"></div>');
        setStatus('Online');
      } catch(err){
        overall.innerHTML = `<div class="mini"><b>Error:</b> ${String(err.message||err)}</div>`;
        setStatus('API error');
      } finally {
        $("homeLoader").style.display = 'none';
      }
    }

    async function renderDay(day){
      showView('day');
      const opts = loadOptions();
      $("dayViewTitle").textContent = `DAY ${day} — Colleges`;
      $("pageTitle").textContent = `Day ${day}`;
      $("pageSubtitle").innerHTML = `Choose a college tracker for <b>Day ${day}</b>. Amount is fixed at <b>₱${FIXED_AMOUNT}</b>.`;
      $("countPill").textContent = "—";
      setCrumbs();

      const box = $("collegeCards");
      box.innerHTML = "";
      for(const col of opts.colleges){
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerHTML = `<div class="k">${col}</div><div class="v">Tracker</div><div class="s">Open Day ${day} · ${col}</div>`;
        tile.addEventListener('click', () => goTracker(day, col));
        box.appendChild(tile);
      }

      $("dayLoader").style.display = '';
      try{
        const s = await fetchSummary(day);
        $("daySummary").innerHTML = buildSummaryHTML(s, `DAY ${day} Summary`);
        setStatus('Online');
      } catch(err){
        $("daySummary").innerHTML = `<div class="mini"><b>Error:</b> ${String(err.message||err)}</div>`;
        setStatus('API error');
      } finally {
        $("dayLoader").style.display = 'none';
      }
    }

    function applyTrackerOptions(opts){
      setSelectOptions($("yearLevel"), opts.years);
      setSelectOptions($("filterYear"), opts.years, {includeAll:true, allLabel:"All"});
      setSelectOptions($("course"), getCoursesForCollege(opts, CURRENT.college));
    }

    function validateForm(){
      const receiptId = $("receiptId").value.trim();
      const studentName = $("studentName").value.trim();
      const studentId = $("studentId").value.trim();
      const yearLevel = $("yearLevel").value;
      const course = $("course").value;

      if(!receiptId) return { ok:false, msg:"Please enter a <b>Receipt ID</b>." };
      if(!studentName) return { ok:false, msg:"Please enter a <b>Student Name</b>." };
      if(!studentId) return { ok:false, msg:"Please enter a <b>Student ID</b>." };
      if(!yearLevel) return { ok:false, msg:"Please select a <b>Year Level</b>." };
      if(!course) return { ok:false, msg:"Please select a <b>Course</b>." };
      return { ok:true, data:{ receiptId, studentName, studentId, yearLevel, course } };
    }

    async function refreshTrackerData(){
      setStatus('Loading…');
      TRACKER_PAYMENTS = await fetchPayments(CURRENT.day, CURRENT.college);
      setStatus('Online');
      renderTrackerTable();
    }

    function renderTrackerTable(){
      const q = $("q").value.trim().toLowerCase();
      const fy = $("filterYear").value;
      let filtered = TRACKER_PAYMENTS;
      if(q){
        filtered = filtered.filter(p =>
          (p.receiptId||"").toLowerCase().includes(q) ||
          (p.studentName||"").toLowerCase().includes(q) ||
          (p.studentId||"").toLowerCase().includes(q) ||
          (p.yearLevel||"").toLowerCase().includes(q) ||
          (p.course||"").toLowerCase().includes(q)
        );
      }
      if(fy) filtered = filtered.filter(p => p.yearLevel === fy);

      const tbody = $("tbody");
      tbody.innerHTML = "";
      for(const p of filtered){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${prettyDate(p.timestamp || p.createdAt)}</td><td class="mono">${p.receiptId}</td><td>${p.studentName}</td><td class="mono">${p.studentId}</td><td>${p.yearLevel}</td><td>${p.course}</td><td class="right">${peso(FIXED_AMOUNT)}</td><td><button class="danger" data-del="${p.id}">Delete</button></td>`;
        tbody.appendChild(tr);
      }

      const uniqueStudents = new Set(TRACKER_PAYMENTS.map(p => String(p.studentId||""))).size;
      $("countPill").textContent = `${TRACKER_PAYMENTS.length} payment${TRACKER_PAYMENTS.length===1?"":"s"}`;
      $("statusPill").textContent = `Paid students: ${uniqueStudents} · Total: ${peso(uniqueStudents * FIXED_AMOUNT)}`;

      tbody.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-del');
          if(!confirm('Delete this payment?')) return;
          try{ await deletePaymentFromServer(id); toast('Payment deleted'); await refreshTrackerData(); }
          catch(err){ toast(`<b>Error:</b> ${String(err.message||err)}`); }
        });
      });
    }

    function resetForm(){
      $("receiptId").value = "";
      $("studentName").value = "";
      $("studentId").value = "";
      $("yearLevel").selectedIndex = 0;
      $("course").selectedIndex = 0;
      $("receiptId").focus();
    }

    async function addPayment(){
      const v = validateForm();
      if(!v.ok){ toast(v.msg); return; }
      const receipt = v.data.receiptId.toLowerCase();
      const dup = TRACKER_PAYMENTS.some(p => String(p.receiptId||"").toLowerCase() === receipt);
      if(dup){ toast('Receipt ID already exists in this tracker.'); return; }

      const payload = { day: CURRENT.day, college: CURRENT.college, receiptId: v.data.receiptId, studentId: v.data.studentId, studentName: v.data.studentName, yearLevel: v.data.yearLevel, course: v.data.course, amount: FIXED_AMOUNT };
      try{ setStatus('Saving…'); await addPaymentToServer(payload); toast('Payment added ✅'); resetForm(); await refreshTrackerData(); }
      catch(err){ setStatus('API error'); toast(`<b>Error:</b> ${String(err.message||err)}`); }
    }

    function exportTrackerCSV(){
      const rows = TRACKER_PAYMENTS.map(p => ({
        Date: prettyDate(p.timestamp || p.createdAt),
        "Receipt ID": p.receiptId,
        "Student Name": p.studentName,
        "Student ID": p.studentId,
        "Year Level": p.yearLevel,
        College: CURRENT.college,
        Course: p.course,
        Amount: FIXED_AMOUNT
      }));
      const header = Object.keys(rows[0] || {Date: ""});
      const csv = [header.join(','), ...rows.map(r => header.map(h => csvEscape(r[h])).join(','))].join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `day${CURRENT.day}_${CURRENT.college}_payments.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast('Exported CSV');
    }

    function exportTrackerPDF(){
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){ toast('PDF library not loaded.'); return; }
      const doc = new jsPDF({ orientation: 'landscape' });
      const title = `DAY ${CURRENT.day} — ${CURRENT.college}`;
      doc.setFontSize(14); doc.text(title, 14, 14);
      doc.setFontSize(10);
      doc.text(`Amount per student: ₱${FIXED_AMOUNT}`, 14, 20);
      doc.text(`Records: ${TRACKER_PAYMENTS.length}`, 14, 26);
      const head = [["Date","Receipt ID","Student Name","Student ID","Year Level","Course","Amount"]];
      const body = TRACKER_PAYMENTS.map(p => [prettyDate(p.timestamp || p.createdAt), p.receiptId, p.studentName, p.studentId, p.yearLevel, p.course, `₱${FIXED_AMOUNT}`]);
      doc.autoTable({ startY: 32, head, body, styles: { fontSize: 8 }, theme: 'grid', margin: { left: 14, right: 14 } });
      doc.save(`day${CURRENT.day}_${CURRENT.college}_payments.pdf`);
      toast('Exported PDF');
    }

    function exportTrackerExcel(){
      if(!window.XLSX){ toast('Excel library not loaded.'); return; }
      const rows = TRACKER_PAYMENTS.map(p => ({
        Date: prettyDate(p.timestamp || p.createdAt),
        "Receipt ID": p.receiptId,
        "Student Name": p.studentName,
        "Student ID": p.studentId,
        "Year Level": p.yearLevel,
        College: CURRENT.college,
        Course: p.course,
        Amount: FIXED_AMOUNT
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Payments');
      XLSX.writeFile(wb, `day${CURRENT.day}_${CURRENT.college}_payments.xlsx`);
      toast('Exported Excel');
    }

    function saveYearsFromEditor(){
      const opts = loadOptions();
      const list = textAreaToList($("yearOptions").value);
      if(!list.length){ toast('Year Levels cannot be empty.'); return; }
      opts.years = list; saveOptions(opts); applyTrackerOptions(opts); toast('Year Levels saved');
    }

    function saveCollegesFromEditor(){
      const opts = loadOptions();
      const list = textAreaToList($("collegeOptions").value);
      if(!list.length){ toast('Colleges cannot be empty.'); return; }
      opts.colleges = list; saveOptions(opts); syncOptionEditors(opts); toast('Colleges saved');
    }

    function saveCoursesFromEditor(){
      const opts = loadOptions();
      opts.courseMap = parseCourseMapFromEditor($("courseOptions").value, opts.colleges);
      saveOptions(opts); applyTrackerOptions(opts); toast('Courses saved');
    }

    function resetYears(){ const opts = loadOptions(); opts.years = structuredClone(defaultOptions.years); saveOptions(opts); syncOptionEditors(opts); applyTrackerOptions(opts); toast('Year Levels reset'); }
    function resetColleges(){ const opts = loadOptions(); opts.colleges = structuredClone(defaultOptions.colleges); saveOptions(opts); syncOptionEditors(opts); toast('Colleges reset'); }
    function resetCourses(){ const opts = loadOptions(); opts.courseMap = structuredClone(defaultOptions.courseMap); saveOptions(opts); syncOptionEditors(opts); applyTrackerOptions(opts); toast('Courses reset'); }

    function bindEvents(){
      $("backHomeBtn").addEventListener('click', goHome);
      $("backDayBtn").addEventListener('click', () => goDay(CURRENT.day));

      $("addBtn").addEventListener('click', addPayment);
      $("resetFormBtn").addEventListener('click', resetForm);
      $("q").addEventListener('input', renderTrackerTable);
      $("filterYear").addEventListener('change', renderTrackerTable);
      $("clearFiltersBtn").addEventListener('click', () => { $("q").value=''; $("filterYear").value=''; renderTrackerTable(); });

      $("saveYearsBtn").addEventListener('click', saveYearsFromEditor);
      $("saveCollegesBtn").addEventListener('click', saveCollegesFromEditor);
      $("saveCoursesBtn").addEventListener('click', saveCoursesFromEditor);
      $("resetYearsBtn").addEventListener('click', resetYears);
      $("resetCollegesBtn").addEventListener('click', resetColleges);
      $("resetCoursesBtn").addEventListener('click', resetCourses);

      $("exportCsvBtn").addEventListener('click', exportTrackerCSV);
      $("exportPdfBtn").addEventListener('click', exportTrackerPDF);
      $("exportXlsxBtn").addEventListener('click', exportTrackerExcel);

      [$("receiptId"), $("studentName"), $("studentId")].forEach(el => el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addPayment(); }));
    }

    async function init(){
      CURRENT = qs();
      bindEvents();
      const opts = loadOptions();
      syncOptionEditors(opts);
      setCrumbs();

      if(!CURRENT.day){ await renderHome(); return; }
      if(CURRENT.day && !CURRENT.college){ await renderDay(CURRENT.day); return; }

      showView('tracker');
      $("trackerTitle").textContent = `DAY ${CURRENT.day} — ${CURRENT.college}`;
      $("pageTitle").textContent = `DAY ${CURRENT.day} — ${CURRENT.college}`;
      $("pageSubtitle").innerHTML = `Tracker for <b>Day ${CURRENT.day}</b>, <b>${CURRENT.college}</b>. Amount is fixed at <b>₱${FIXED_AMOUNT}</b>.`;
      $("collegeLocked").value = CURRENT.college;

      applyTrackerOptions(opts);
      await refreshTrackerData();
    }

    init().catch(err => { setStatus('Setup error'); toast(`<b>Setup error:</b> ${String(err.message||err)}`); });
  </script>
</body>
</html>
